{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","ALL_OPERATORS","DEFAULT_DEVICE","DEFAULT_GROUP_BY","DEFAULT_GROUP_BY_OP","DEFAULT_SELECT_FIELD","DEFAULT_SELECT_NS","DEFAULT_WHERE","GenericDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","scope","target","namespace","device_id","group_by_field","group_by_operator","interval","panelCtrl","limit_by_field","limit_by_count","wheres","newPlusButton","i","length","j","temp","type","newClause","newSegment","value","cssClass","rowIdx","field","del","html","button","push","segment","idx","addWhereRow","splice","refresh","Promise","event","datasource","fieldQuery","then","transformToSegments","results","text","concat","limitByFieldsQuery","namespaceQuery","deviceQuery","operators","resolve","map","v","rawQuery","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!'\nimport {\n    ALL_OPERATORS,\n    DEFAULT_DEVICE,\n    DEFAULT_GROUP_BY,\n    DEFAULT_GROUP_BY_OP,\n    DEFAULT_SELECT_FIELD,\n    DEFAULT_SELECT_NS,\n    DEFAULT_WHERE\n} from \"./constants\";\n\nexport class GenericDatasourceQueryCtrl extends QueryCtrl {\n\n    constructor($scope, $injector, uiSegmentSrv)  {\n        super($scope, $injector);\n\n        this.scope = $scope;\n        this.uiSegmentSrv = uiSegmentSrv;\n        this.target.target = this.target.target || DEFAULT_SELECT_FIELD;\n        this.target.namespace = this.target.namespace || DEFAULT_SELECT_NS;\n        this.target.device_id = this.target.device_id || DEFAULT_DEVICE;\n        this.target.group_by_field = this.target.group_by_field || DEFAULT_GROUP_BY;\n        this.target.group_by_operator = this.target.group_by_operator || DEFAULT_GROUP_BY_OP;\n        this.target.interval = this.target.interval || this.panelCtrl.interval;\n        this.target.limit_by_field = this.target.limit_by_field || DEFAULT_GROUP_BY;\n        this.target.limit_by_count = this.target.limit_by_count || 1;\n\n        this.target.wheres = this.target.wheres || [[this.uiSegmentSrv.newPlusButton()]];\n        for (let i = 0; i < this.target.wheres.length; i++) {\n            for (let j = 0; j < this.target.wheres[i].length; j++) {\n                const temp = this.target.wheres[i][j];\n                if (temp.type === \"clause\") {\n                    const newClause = this.uiSegmentSrv.newSegment(temp.value);\n                    newClause.cssClass = temp.cssClass;\n                    newClause.type = temp.type;\n                    this.target.wheres[i][j] = newClause;\n                }\n            }\n        }\n\n    }\n\n    /** Add a new where row to the UI, pushing down the plus button **/\n    addWhereRow(rowIdx) {\n        const field = this.uiSegmentSrv.newSegment(\"\");\n        field.cssClass = \"io-segment io-where-clause\";\n        field.type = \"clause\";\n        const del = this.uiSegmentSrv.newSegment(\"\");\n        del.html = \"<i class=\\\"fa fa-trash\\\"></i>\";\n        del.type = \"delete\";\n        del.cssClass = \"io-segment\";\n        const button = this.uiSegmentSrv.newPlusButton();\n        button.cssClass = \"io-segment-no-left\";\n\n        this.target.wheres[rowIdx] = [field, del];\n        this.target.wheres.push([button]);\n    }\n\n    // Only handles clicks for plus buttons and delete buttons\n    wheresClicked(segment, rowIdx, idx) {\n        // Handle plus button clicks\n        if (segment.type === \"plus-button\") {\n            // Only add a row if the previous one is non-empty clause\n            if (rowIdx === 0 || this.target.wheres[rowIdx - 1][0].value !== \"\") {\n                this.addWhereRow(rowIdx);\n            } else {  // Prevents user from 'editting' the button\n                this.target.wheres[rowIdx][idx] = this.uiSegmentSrv.newPlusButton();\n            }\n        } else if (segment.type === \"delete\") {  // Handle delete clicks\n            this.target.wheres.splice(rowIdx, 1);\n            this.panelCtrl.refresh();\n        }\n        return new Promise(() => {});\n    }\n\n    wheresUpdated(segment, rowIdx, idx) {\n        this.panelCtrl.refresh();\n    }\n\n    // Handles when a clause is actually entered\n    wheresEntered(event, rowIdx, idx) {\n        if (event && event.target) {\n            this.target.wheres[rowIdx][idx].value = event.target.value;\n            this.panelCtrl.refresh();\n        }\n    }\n\n    limitCount(event) {\n        this.target.limit_by_count = event.target.value;\n        this.panelCtrl.refresh();\n    }\n\n    // No options for clicking on interval, just a text field.\n    intervalClicked() {\n        return new Promise(() => {});\n    }\n\n    getOptions() {\n        return this.datasource.fieldQuery(this.target)\n            .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    getGroupByOptions() {\n        return this.datasource.fieldQuery(this.target)\n            .then((results) => {\n                return [{value: DEFAULT_GROUP_BY, text: DEFAULT_GROUP_BY}].concat(results);\n            })\n            .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    getLimitByOptions() {\n        return this.datasource.limitByFieldsQuery(this.target)\n            .then((results) => {\n                return [{value: DEFAULT_GROUP_BY, text: DEFAULT_GROUP_BY}].concat(results);\n            })\n            .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    getNamespaces() {\n        return this.datasource.namespaceQuery(this.target)\n            .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    getDevices() {\n        return this.datasource.deviceQuery(this.target)\n            .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    getOperators() {\n        const operators = [\"mean\", \"max\", \"min\", \"sum\", \"count\"];\n        return new Promise((resolve) => {\n            resolve(ALL_OPERATORS.map((v) => {\n                return {text: v, value: v};\n            }));\n        }).then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    toggleEditorMode() {\n        this.target.rawQuery = !this.target.rawQuery;\n    }\n\n    onChangeInternal() {\n        this.panelCtrl.refresh(); // Asks the panel to refresh data.\n    }\n}\n\nGenericDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n"]}