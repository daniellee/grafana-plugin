{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","_","ALL_OPERATORS","ALL_DEVICES","DEFAULT_DEVICE","DEFAULT_GROUP_BY_OP","DEFAULT_SELECT_FIELD","DEFAULT_SELECT_NS","DEFAULT_SELECT_PROJECT","DEFAULT_WHERE","NONE","iobeamDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","scope","target","device_id","group_by_field","group_by_operator","interval","panelCtrl","limit_by_field","limit_by_count","wheres","newPlusButton","i","length","j","temp","type","newClause","newSegment","value","cssClass","projectSegment","getSegmentForValue","project","namespaceSegment","namespace","fieldSegment","deviceSegment","rowIdx","field","del","html","button","push","segment","idx","addWhereRow","splice","refresh","Promise","event","datasource","fieldQuery","then","transformToSegments","results","text","concat","limitByFieldsQuery","projectQuery","self","namespaceQuery","deviceQuery","operators","resolve","map","v","rawQuery","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from \"app/plugins/sdk\";\nimport \"./css/query-editor.css!\";\nimport _ from \"lodash\";\nimport {\n    ALL_OPERATORS,\n    ALL_DEVICES,\n    DEFAULT_DEVICE,\n    DEFAULT_GROUP_BY_OP,\n    DEFAULT_SELECT_FIELD,\n    DEFAULT_SELECT_NS,\n    DEFAULT_SELECT_PROJECT,\n    DEFAULT_WHERE,\n    NONE\n} from \"./constants\";\n\nexport class iobeamDatasourceQueryCtrl extends QueryCtrl {\n\n    constructor($scope, $injector, uiSegmentSrv)  {\n        super($scope, $injector);\n\n        this.scope = $scope;\n        this.target = this.target;\n        this.uiSegmentSrv = uiSegmentSrv;\n        this.target.target = this.target.target || DEFAULT_SELECT_FIELD;\n        this.target.device_id = this.target.device_id || DEFAULT_DEVICE;\n        this.target.group_by_field = this.target.group_by_field || NONE;\n        this.target.group_by_operator = this.target.group_by_operator || DEFAULT_GROUP_BY_OP;\n        this.target.interval = this.target.interval || this.panelCtrl.interval;\n        this.target.limit_by_field = this.target.limit_by_field || NONE;\n        this.target.limit_by_count = this.target.limit_by_count || 1;\n\n        this.target.wheres = this.target.wheres || [[this.uiSegmentSrv.newPlusButton()]];\n        for (let i = 0; i < this.target.wheres.length; i++) {\n            for (let j = 0; j < this.target.wheres[i].length; j++) {\n                const temp = this.target.wheres[i][j];\n                if (temp.type === \"clause\") {\n                    const newClause = this.uiSegmentSrv.newSegment(temp.value);\n                    newClause.cssClass = temp.cssClass;\n                    newClause.type = temp.type;\n                    this.target.wheres[i][j] = newClause;\n                }\n            }\n        }\n        this.projectSegment = uiSegmentSrv.getSegmentForValue(this.target.project, DEFAULT_SELECT_PROJECT);\n        this.namespaceSegment = uiSegmentSrv.getSegmentForValue(this.target.namespace, DEFAULT_SELECT_NS);\n        this.fieldSegment = uiSegmentSrv.getSegmentForValue(this.target.target, DEFAULT_SELECT_FIELD);\n        this.deviceSegment = uiSegmentSrv.getSegmentForValue(this.target.device_id, DEFAULT_DEVICE);\n    }\n\n    /** Add a new where row to the UI, pushing down the plus button **/\n    addWhereRow(rowIdx) {\n        const field = this.uiSegmentSrv.newSegment(\"\");\n        field.cssClass = \"io-segment io-where-clause\";\n        field.type = \"clause\";\n        const del = this.uiSegmentSrv.newSegment(\"\");\n        del.html = \"<i class=\\\"fa fa-trash\\\"></i>\";\n        del.type = \"delete\";\n        del.cssClass = \"io-segment\";\n        const button = this.uiSegmentSrv.newPlusButton();\n        button.cssClass = \"io-segment-no-left\";\n\n        this.target.wheres[rowIdx] = [field, del];\n        this.target.wheres.push([button]);\n    }\n\n    // Only handles clicks for plus buttons and delete buttons\n    wheresClicked(segment, rowIdx, idx) {\n        // Handle plus button clicks\n        if (segment.type === \"plus-button\") {\n            // Only add a row if the previous one is non-empty clause\n            if (rowIdx === 0 || this.target.wheres[rowIdx - 1][0].value !== \"\") {\n                this.addWhereRow(rowIdx);\n            } else {  // Prevents user from 'editting' the button\n                this.target.wheres[rowIdx][idx] = this.uiSegmentSrv.newPlusButton();\n            }\n        } else if (segment.type === \"delete\") {  // Handle delete clicks\n            this.target.wheres.splice(rowIdx, 1);\n            this.panelCtrl.refresh();\n        }\n        return new Promise(() => {});\n    }\n\n    wheresUpdated(segment, rowIdx, idx) {\n        this.panelCtrl.refresh();\n    }\n\n    // Handles when a clause is actually entered\n    wheresEntered(event, rowIdx, idx) {\n        if (event && event.target) {\n            this.target.wheres[rowIdx][idx].value = event.target.value;\n            this.panelCtrl.refresh();\n        }\n    }\n\n    limitCount(event) {\n        this.target.limit_by_count = event.target.value;\n        this.panelCtrl.refresh();\n    }\n\n    // No options for clicking on interval, just a text field.\n    intervalClicked() {\n        return new Promise(() => {});\n    }\n\n    getOptions() {\n        return this.datasource.fieldQuery(this.target)\n            .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    getGroupByOptions() {\n        return this.datasource.fieldQuery(this.target)\n            .then((results) => {\n                return [{value: NONE, text: NONE}].concat(results);\n            })\n            .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    getLimitByOptions() {\n        return this.datasource.limitByFieldsQuery(this.target)\n            .then((results) => {\n                return [{value: NONE, text: NONE}].concat(results);\n            })\n            .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    getProjects() {\n        return this.datasource.projectQuery()\n            .then((results) => {\n                return [{text: NONE, value: NONE}].concat(results);\n            })\n            .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    getNamespaces() {\n        const self = this;\n        return this.datasource.namespaceQuery(this.target)\n            .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    getDevices() {\n        return this.datasource.deviceQuery(this.target)\n            .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    getOperators() {\n        const operators = [NONE].concat(ALL_OPERATORS);\n        return new Promise((resolve) => {\n            resolve(operators.map((v) => {\n                return {text: v, value: v};\n            }));\n        }).then(this.uiSegmentSrv.transformToSegments(false));\n    }\n\n    toggleEditorMode() {\n        this.target.rawQuery = !this.target.rawQuery;\n    }\n\n    onChangeInternal() {\n        this.refresh(); // Asks the panel to refresh data.\n    }\n\n    onChangeDevice() {\n        this.target.device_id = this.deviceSegment.value;\n        this.refresh();\n    }\n\n    onChangeNamespace() {\n        this.target.namespace = this.namespaceSegment.value;\n        this.refresh();\n    }\n\n    onChangeField() {\n        this.target.target = this.fieldSegment.value;\n        this.refresh();\n    }\n\n    onChangeProject() {\n        // reset namespace value in selector\n        this.namespaceSegment.value = DEFAULT_SELECT_NS;\n        this.namespaceSegment.html = DEFAULT_SELECT_NS;\n        this.fieldSegment.value = DEFAULT_SELECT_FIELD;\n        this.fieldSegment.html = DEFAULT_SELECT_FIELD;\n        this.deviceSegment.value = DEFAULT_DEVICE;\n        this.deviceSegment.html = DEFAULT_DEVICE;\n        this.target.project = this.projectSegment.value;\n        this.refresh();\n    }\n}\n\niobeamDatasourceQueryCtrl.templateUrl = \"partials/query.editor.html\";\n"]}
